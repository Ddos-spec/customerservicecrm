-- Skema terkini (seragam pakai UUID untuk tenant & user)

-- Tenants
CREATE TABLE public.tenants (
  id                 UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_name       TEXT NOT NULL,
  status             VARCHAR(20) DEFAULT 'active',
  session_id         TEXT UNIQUE,
  max_active_members INT DEFAULT 100,
  created_at         TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Users (super_admin / admin_agent / agent)
CREATE TABLE public.users (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id     UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  name          TEXT NOT NULL,
  email         TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  role          VARCHAR(20) NOT NULL, -- super_admin | admin_agent | agent
  status        VARCHAR(20) DEFAULT 'active',
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT now()
);
CREATE INDEX idx_users_tenant_role_status ON public.users (tenant_id, role, status);

-- Tenant membership (optional multi-member); admin_agent ditandai is_tenant_admin = true
CREATE TABLE public.tenant_members (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  user_id         UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  display_name    TEXT,
  is_tenant_admin BOOLEAN NOT NULL DEFAULT false,
  status          VARCHAR(20) NOT NULL DEFAULT 'active',
  created_at      TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE (tenant_id, user_id)
);
CREATE INDEX idx_tenant_members_tenant ON public.tenant_members (tenant_id);
CREATE INDEX idx_tenant_members_user ON public.tenant_members (user_id);

-- User invites (dipakai admin_agent untuk bikin user_agent)
CREATE TABLE public.user_invites (
  id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id  UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  name       TEXT NOT NULL,
  email      TEXT NOT NULL,
  role       VARCHAR(20) NOT NULL DEFAULT 'agent',
  token      TEXT NOT NULL UNIQUE,
  status     VARCHAR(20) NOT NULL DEFAULT 'pending',
  created_by UUID REFERENCES public.users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  expires_at TIMESTAMP WITH TIME ZONE
);
CREATE INDEX user_invites_status_idx ON public.user_invites (status);
CREATE INDEX user_invites_tenant_id_idx ON public.user_invites (tenant_id);
CREATE INDEX user_invites_email_idx ON public.user_invites (email);

-- Tickets & messaging (tenant-scoped, assign ke user)
CREATE TABLE public.tickets (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id         UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  customer_name     TEXT,
  customer_contact  TEXT,
  status            VARCHAR(50) DEFAULT 'open',
  assigned_agent_id UUID REFERENCES public.users(id) ON DELETE SET NULL,
  internal_notes    TEXT,
  created_at        TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at        TIMESTAMP WITH TIME ZONE DEFAULT now()
);
CREATE INDEX idx_tickets_tenant_id ON public.tickets (tenant_id);
CREATE INDEX idx_tickets_assigned_agent ON public.tickets (assigned_agent_id);

CREATE TABLE public.messages (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ticket_id   UUID NOT NULL REFERENCES public.tickets(id) ON DELETE CASCADE,
  sender_type VARCHAR(20) NOT NULL, -- agent | customer | system
  message_text TEXT,
  file_url    TEXT,
  created_at  TIMESTAMP WITH TIME ZONE DEFAULT now()
);
CREATE INDEX idx_messages_ticket_id ON public.messages (ticket_id);
CREATE INDEX idx_messages_created_at ON public.messages (created_at);

-- Tenant integrations (session WA) + webhooks
CREATE TABLE public.tenant_integrations (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id     UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  provider      TEXT NOT NULL DEFAULT 'baileys',
  session_key   TEXT,
  last_seen_at  TIMESTAMP WITH TIME ZONE,
  is_connected  BOOLEAN NOT NULL DEFAULT false,
  meta          JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE (tenant_id)
);

CREATE TABLE public.tenant_webhooks (
  id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id  UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  url        TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE (tenant_id, url)
);
CREATE INDEX tenant_webhooks_tenant_id_idx ON public.tenant_webhooks (tenant_id);

-- Kontak & percakapan (tetap UUID, sudah tenant-scoped)
CREATE TABLE public.contacts (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id    UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  display_name TEXT,
  push_name    TEXT,
  created_at   TIMESTAMP WITH TIME ZONE DEFAULT now()
);
CREATE INDEX idx_contacts_tenant ON public.contacts (tenant_id);

CREATE TABLE public.contact_identifiers (
  id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id  UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  contact_id UUID NOT NULL REFERENCES public.contacts(id) ON DELETE CASCADE,
  kind       TEXT NOT NULL,
  value      TEXT NOT NULL,
  is_primary BOOLEAN NOT NULL DEFAULT true,
  active     BOOLEAN NOT NULL DEFAULT true,
  verified_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE (tenant_id, kind, value)
);
CREATE INDEX idx_contact_identifiers_contact ON public.contact_identifiers (contact_id);

CREATE TABLE public.conversations (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id        UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  channel          TEXT NOT NULL DEFAULT 'whatsapp',
  contact_id       UUID NOT NULL REFERENCES public.contacts(id) ON DELETE RESTRICT,
  status           VARCHAR(30) NOT NULL DEFAULT 'open',
  assigned_user_id UUID REFERENCES public.users(id) ON DELETE SET NULL,
  escalated_at     TIMESTAMP WITH TIME ZONE,
  last_message_at  TIMESTAMP WITH TIME ZONE DEFAULT now(),
  created_at       TIMESTAMP WITH TIME ZONE DEFAULT now()
);
CREATE INDEX idx_conversations_tenant_status ON public.conversations (tenant_id, status);
CREATE INDEX idx_conversations_tenant_lastmsg ON public.conversations (tenant_id, last_message_at DESC);

CREATE TABLE public.conversation_events (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id        UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  conversation_id  UUID NOT NULL REFERENCES public.conversations(id) ON DELETE CASCADE,
  event_type       TEXT NOT NULL,
  reason           TEXT,
  payload          JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_by_user_id UUID REFERENCES public.users(id) ON DELETE SET NULL,
  created_at       TIMESTAMP WITH TIME ZONE DEFAULT now()
);
CREATE INDEX idx_events_conv_time ON public.conversation_events (conversation_id, created_at DESC);

-- Audit logs
CREATE TABLE public.audit_logs (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id     UUID REFERENCES public.tenants(id) ON DELETE CASCADE,
  actor_user_id UUID REFERENCES public.users(id) ON DELETE SET NULL,
  action        TEXT NOT NULL,
  target_type   TEXT,
  target_id     UUID,
  ip            TEXT,
  user_agent    TEXT,
  metadata      JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT now()
);
CREATE INDEX idx_audit_actor_time ON public.audit_logs (actor_user_id, created_at DESC);
CREATE INDEX idx_audit_tenant_time ON public.audit_logs (tenant_id, created_at DESC);

-- Notes:
-- - Pastikan extension pgcrypto tersedia untuk gen_random_uuid().
-- - Seat limit trigger bisa pakai tenants.max_active_members terhadap tenant_members.status = 'active'.
