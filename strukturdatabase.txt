-- STRUKTUR DATABASE CRM V2 (Simplified & WA-Centric)
-- Update: 2026-01-14

-- 1. TENANTS (Perusahaan/Klien)
CREATE TABLE public.tenants (
  id                 UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_name       TEXT NOT NULL,
  status             VARCHAR(20) DEFAULT 'active',
  session_id         TEXT UNIQUE, -- Format internasional (62...)
  created_at         TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 2. USERS (Admin / Agent)
CREATE TABLE public.users (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id     UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  name          TEXT NOT NULL,
  email         TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  role          VARCHAR(20) NOT NULL, -- super_admin | admin_agent | agent
  status        VARCHAR(20) DEFAULT 'active',
  session_id    TEXT, -- Session WA khusus super_admin
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 3. CONTACTS (Database Pelanggan)
CREATE TABLE public.contacts (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  jid             TEXT NOT NULL, -- WhatsApp JID
  phone_number    TEXT,
  display_name    TEXT,
  push_name       TEXT,
  full_name       TEXT,
  profile_pic_url TEXT,
  is_business     BOOLEAN DEFAULT false,
  about_status    TEXT,
  created_at      TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at      TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE (tenant_id, jid)
);
CREATE INDEX idx_contacts_tenant_jid ON public.contacts (tenant_id, jid);

-- 4. CHATS (Daftar Percakapan / Inbox)
CREATE TABLE public.chats (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
  contact_id      UUID NOT NULL REFERENCES public.contacts(id) ON DELETE CASCADE,
  assigned_to     UUID REFERENCES public.users(id) ON DELETE SET NULL,
  status          VARCHAR(20) DEFAULT 'open', -- open | resolved
  unread_count    INT DEFAULT 0,
  last_message_preview TEXT,
  last_message_time    TIMESTAMP WITH TIME ZONE DEFAULT now(),
  last_message_type    VARCHAR(20) DEFAULT 'text',
  created_at      TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at      TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE (tenant_id, contact_id)
);
CREATE INDEX idx_chats_tenant_updated ON public.chats (tenant_id, updated_at DESC);

-- 5. MESSAGES (Riwayat Pesan)
CREATE TABLE public.messages (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  chat_id         UUID NOT NULL REFERENCES public.chats(id) ON DELETE CASCADE,
  sender_type     VARCHAR(20) NOT NULL, -- agent | customer | system
  sender_id       TEXT, -- JID atau User ID
  sender_name     TEXT,
  message_type    VARCHAR(20) DEFAULT 'text',
  body            TEXT,
  media_url       TEXT,
  wa_message_id   TEXT,
  is_from_me      BOOLEAN DEFAULT false,
  status          VARCHAR(20) DEFAULT 'sent',
  created_at      TIMESTAMP WITH TIME ZONE DEFAULT now()
);
CREATE INDEX idx_messages_chat_time ON public.messages (chat_id, created_at ASC);

-- 6. SYSTEM SETTINGS
CREATE TABLE public.system_settings (
  key   TEXT PRIMARY KEY,
  value TEXT NOT NULL
);