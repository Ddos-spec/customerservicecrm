# ðŸš€ CODEX TASK: Implement Marketing Module (WA Blast) End-to-End [STRICT MODE]

**Context:**
We are building a SaaS CRM (Omnichannel WhatsApp) with a Hybrid Provider architecture (Whatsmeow + Meta Cloud API). The database schema for the Marketing Module (`campaigns`, `contact_groups`, `campaign_messages`) has already been applied via Migration V6.

**Objective:**
Implement the **Marketing Module** functionality. Focus on SAFETY, STABILITY, and PERFORMANCE. Do not invent new architectural patterns; follow the existing `backend/routes/*.js` style.

---

## ðŸ› ï¸ STEP 1: Backend Logic (Node.js/Express)

### 1. Create `backend/routes/marketing.js`
*   **Dependencies:** `express`, `router`, `db` (from `../db`), `validateToken` (passed in deps).
*   **Boilerplate:** Use `function buildMarketingRouter(deps) { ... }` pattern.
*   **Endpoints to Implement:**

    *   `POST /groups`
        *   Body: `{ name, description }`
        *   SQL: `INSERT INTO contact_groups ... RETURNING *`
    
    *   `POST /groups/:groupId/members` (Bulk Import)
        *   Body: `{ contact_ids: ["uuid", ...] }`
        *   **CRITICAL:** Use a single SQL transaction or Batch Insert. DO NOT loop `INSERT` statements in JS.
        *   SQL Hint: `INSERT INTO contact_group_members (contact_id, group_id) VALUES ... ON CONFLICT DO NOTHING`

    *   `POST /campaigns` (Create Blast)
        *   Body: `{ name, message_template, scheduled_at, group_ids: ["uuid"] }`
        *   **Step A:** Insert Campaign Header -> Get `campaign_id`.
        *   **Step B (The Magic):** Use SQL `INSERT INTO ... SELECT` to copy targets from `contact_group_members` to `campaign_messages` queue.
        *   **Query Hint:**
            ```sql
            INSERT INTO campaign_messages (campaign_id, contact_id, phone_number, status)
            SELECT $1, c.id, c.phone_number, 'pending'
            FROM contact_group_members cgm
            JOIN contacts c ON c.id = cgm.contact_id
            WHERE cgm.group_id = ANY($2::uuid[])
            ```
        *   This ensures 1000 targets are queued in milliseconds without loading Node.js memory.

    *   `GET /campaigns`
        *   List campaigns with pagination.

### 2. Implement `CampaignProcessor` (The Engine)
*   **File:** `backend/services/marketing/processor.js`
*   **Dependencies:** `db`, `ProviderFactory`.
*   **Logic:**
    *   Export a function `processBatch()`.
    *   **Query:** Fetch `campaign_messages` where `status = 'pending'` AND `campaign.scheduled_at <= NOW()` AND `campaign.status != 'paused'`.
    *   **Limit:** `LIMIT 50` (Hard limit per batch run).
    *   **Loop:**
        *   For each message:
            1.  Get Tenant info (for ProviderFactory).
            2.  `ProviderFactory.getProvider(tenant).sendText(...)`.
            3.  Update `campaign_messages` status to `sent` or `failed`.
            4.  Update `campaigns` success/failed counters (Atomic Increment).
    *   **Concurrency:** Use `SKIP LOCKED` in SQL if possible, or just rely on status update speed for now.

### 3. Mount Router & Scheduler
*   **File:** `backend/api_v1.js` -> Mount `router.use('/marketing', buildMarketingRouter(...))`
*   **File:** `backend/index.js` -> Initialize `setInterval(() => processor.processBatch(), 60000);` (Run every 1 minute).

---

## ðŸ’» STEP 2: Frontend UI (React/Vite)

**1. Create Pages in `frontend/src/pages/marketing/`**
*   `CampaignList.tsx`: Table showing campaigns. Columns: Name, Status, Progress (Success/Total), Created At.
*   `CreateCampaign.tsx`: Form wizard.
    *   *Input:* Name, Message (TextArea), Schedule (DateTime Picker).
    *   *Target:* Dropdown Multi-select for "Contact Groups".
*   `ContactGroups.tsx`:
    *   List Groups.
    *   Modal: "Add Members" (Select from existing Contacts table).

**2. Update Navigation**
*   Add "Marketing" item to Sidebar in `frontend/src/layouts/MainLayout.tsx`.

---

## ðŸ”’ Constraints (DO NOT VIOLATE)

1.  **Tenant Isolation:** ALL SQL Queries MUST include `WHERE tenant_id = $id`. Never leak data between tenants.
2.  **Rate Limiting:** The `processBatch` must strictly respect the limit (e.g., 50 msgs/min). Do not try to send "as fast as possible".
3.  **No Loops in Routes:** Endpoints must return quickly. Heavy lifting (sending messages) happens ONLY in `CampaignProcessor`.

---

## ðŸ§ª Verification Steps

1.  Create a Group "Alpha Team".
2.  Add 2 contacts to "Alpha Team".
3.  Create Campaign "Promo Januari" scheduled for *Now*.
4.  Wait 1 minute.
5.  Check if messages are delivered.
6.  Check if `campaigns` table stats are updated.